<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.7.0/mapbox-gl.js'></script>
    <script type="text/javascript" src="lib/tabletop.js"></script>
    <script type="text/javascript" src="lib/proj4.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.7.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
proj4.defs("EPSG:32633","+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs");

mapboxgl.accessToken = 'pk.eyJ1IjoiYmFrayIsImEiOiJucGluZjdFIn0.yRHgsbqP2PuZ7iMXR56Ekw';
var map = new mapboxgl.Map({
  container: 'map', // container id
  style: 'https://www.mapbox.com/mapbox-gl-styles/styles/basic-v7.json', //stylesheet location
  center: [68, 10], // starting position
  zoom:4 // starting zoom
});
map.fitBounds([ [57.5, 4], [72, 31.5] ]);

map.on('style.load', function() {

      mapboxgl.util.getJSON('route.geojson', function (err, geojson) {
        if (err) throw err;
        window.geojson1 = geojson;
        var clonedGeojson = JSON.parse(JSON.stringify(geojson));
        window.geojson2 = clonedGeojson;
        var sourceObj = new mapboxgl.GeoJSONSource({
          data: geojson
        });
        distances = calculateDistances(geojson);
        window.distancemap = distances;
        Tabletop.init( { key: '0AtfTjSZCvAfkdHRSQ0JRNHFHZFVIQXBEVXBMamwteWc',
                 callback: function(data, tabletop) { initData(data) },
                 simpleSheet: true } )
    });
  }); 

function initData(data) {
    var totalKm = Number(data[0]['jogging'].replace(/,/g,'.'));
    distancemap = window.distancemap;
    var found;
    var i = 0;
    for (var key in distancemap) {
      i = i + 1;
      found = key;
      if (key> totalKm*1000) {
        break;
      }
    }
    var coordinates = geojson1['features'][0]['geometry']['coordinates'];
    for (var i = 0; i < coordinates.length; i++){
      if (coordinates[i][0] === distancemap[found][0]) {
        break;
      }
    }
    i = i + 1;
    coordinates.splice(i, coordinates.length-i);
    var coordinates2 = geojson2['features'][0]['geometry']['coordinates'];
    coordinates2.splice(0, i-1);

    var sourceObj2 = new mapboxgl.GeoJSONSource({
      data: geojson2
    });

    var sourceObj = new mapboxgl.GeoJSONSource({
      data: geojson1
    });
    map.addSource('myroute', sourceObj); 
    map.addSource('myroute2', sourceObj2); 

    map.addLayer({
      "id": "route",
      "type": "line",
      "source": "myroute",
      "layout": {
        "line-join": "round",
        "line-cap": "round"
      },
      "paint": {
        "line-color": "#000000",
        "line-width": 2,
        "line-opacity": 0.2
      }
    },"place_label_city");

    map.addLayer({
      "id": "route2",
      "type": "line",
      "source": "myroute2",
      "layout": {
        "line-join": "round",
        "line-cap": "round"
      },
      "paint": {
        "line-color": "#ff6400",
        "line-width": 3
      }
    },"place_label_city");
    showMarker(found, distancemap);
}

function showMarker(key, distancemap) {
    map.addSource("markers", {
      "type": "geojson",
      "data": {
        "type": "FeatureCollection",
        "features": [{
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": distancemap[key] //25.781588,71.167982
          },
          "properties": {
            "title": '' + Math.round(key/1000) + ' km',
            "marker-symbol": "school-24",
            "text-size": 16
          }
        }, {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [25.781588, 71.167982]
          },
          "properties": {
            "title": "Nordkapp 2540 km",
            "marker-symbol": "circle-stroked-18",
            "text-size": 12
          }
        }, {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [ 7.109169, 58.018015]
          },
          "properties": {
            "title": "Lindesnes 0 km",
            "marker-symbol": "triangle-stroked-18",
            "text-size": 8
          }
        }]
      }
    });

    map.addLayer({
      "id": "markers",
      "type": "symbol",
      "source": "markers",
      "layout": {
        "icon-image": "{marker-symbol}",
        "text-field": "{title}",
        "text-font": "Open Sans Semibold, Arial Unicode MS Bold",
        "text-offset": [0, 0.8],
        "text-anchor": "top"
      },
      "paint": {
        "text-size": 12,
        "text-halo-width": 2,
        "text-halo-color": "#eee"
      }
    },13);

}


function calculateDistance(a, b) {
  var sum = 0;
  var n;
  for (n=0; n < a.length; n++) {
    sum += Math.pow(a[n]-b[n], 2);
  }
  return Math.sqrt(sum);
}

function calculateDistances(geojson) {
  var coordinates = geojson['features'][0]['geometry']['coordinates'];
  var count = 0;
  distances = {};
  var max = coordinates.length -1;
  var lastcoord;
  var lastdistance = 0;
  for(var i = max; i>=0 ; i--) {
    count++;
    utmcoord = proj4('EPSG:32633', coordinates[i]);

    if (i == max) {
      distances[0] = coordinates[i];
    } else {
      distance = calculateDistance(lastcoord,utmcoord);
      var cummulativeSum;
      if (isNaN(lastdistance)) {
        cummulativeSum = distance;
      } else {
        cummulativeSum = lastdistance + distance;
      }
      distances[''+(cummulativeSum)] = coordinates[i];
    }
    lastcoord = utmcoord;
    lastdistance = cummulativeSum;
  }
  return distances;
}
</script>

</body>
</html>